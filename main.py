# Define the raw string input
raw_inputnew = """
MATHS 3025 - Professional Practice III Workshop
01 Mar - 05 Apr Friday 2:00 PM - 4:00 PM
Engineering & Mathematics EM212, Teaching Room
26 Apr - 31 May Friday 2:00 PM - 4:00 PM
Engineering & Mathematics EM212, Teaching Room

COMP SCI 3315 - Computer Vision UG Lecture
29 Feb - 04 Apr Thursday 1:00 PM - 3:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
25 Apr - 06 Jun Thursday 1:00 PM - 3:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre

COMP SCI 3007 - Artificial Intelligence UG Lecture
26 Feb - 01 Apr Monday 3:00 PM - 4:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
28 Feb - 03 Apr Wednesday 3:00 PM - 4:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
22 Apr - 27 May Monday 3:00 PM - 4:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
24 Apr - 29 May Wednesday 3:00 PM - 4:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre

COMP SCI 3007 - Artificial Intelligence UG Workshop
07 Mar Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
21 Mar Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
04 Apr Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
02 May Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
16 May Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room

COMP SCI 3315 - Computer Vision UG Workshop
15 Mar Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
05 Apr Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
10 May Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
31 May Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
"""
raw_input1 = """
COMP SCI 3007 - Artificial Intelligence UG Workshop
07 Mar Thursday 4:00 PM - 5:00 PM  
Engineering Nth N218, Teaching Room
21 Mar Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
04 Apr Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
02 May Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room
16 May Thursday 4:00 PM - 5:00 PM
Engineering Nth N218, Teaching Room

COMP SCI 3315 - Computer Vision UG Workshop
15 Mar Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
05 Apr Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
10 May Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
31 May Friday 4:00 PM - 5:00 PM
Hughes 323, Teaching Room
"""

raw_input="""
COMP SCI 7081 - Computer Systems PG Lecture
27 Feb - 02 Apr Tuesday 9:00 AM - 10:00 AM
The Braggs G60, Bragg Lecture Theatre 
29 Feb - 04 Apr Thursday 9:00 AM - 10:00 AM
The Braggs G60, Bragg Lecture Theatre
23 Apr - 04 Jun Tuesday 9:00 AM - 10:00 AM
The Braggs G60, Bragg Lecture Theatre
25 Apr - 06 Jun Thursday 9:00 AM - 10:00 AM
The Braggs G60, Bragg Lecture Theatre

COMP SCI 7081 - Computer Systems PG Lecture Workshop
05 Mar - 02 Apr Tuesday 12:00 PM - 1:00 PM
Ingkarni Wardli G22, CAT Suite
23 Apr - 04 Jun Tuesday 12:00 PM - 1:00 PM
Ingkarni Wardli G22, CAT Suite

COMP SCI 7201 - Alg Data Structure Analysis PG Lecture
26 Feb - 01 Apr Monday 4:00 PM - 5:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
01 Mar - 05 Apr Friday 2:00 PM - 3:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
22 Apr - 27 May Monday 4:00 PM - 5:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre
26 Apr - 31 May Friday 2:00 PM - 3:00 PM
Helen Mayo Nth 103N, Florey Lecture Theatre

COMP SCI 7201 - Alg Data Structure Analysis PG Workshop
07 Mar Thursday 1:00 PM - 2:00 PM
Hartley 122a, Teaching Room
21 Mar Thursday 1:00 PM - 2:00 PM
Hartley 122a, Teaching Room
04 Apr Thursday 1:00 PM - 2:00 PM
Hartley 122a, Teaching Room
02 May Thursday 1:00 PM - 2:00 PM
Hartley 122a, Teaching Room
16 May Thursday 1:00 PM - 2:00 PM
Hartley 122a, Teaching Room
30 May Thursday 1:00 PM - 2:00 PM
Hartley 122a, Teaching Room

COMP SCI 7306 - Mining Big Data PG Lecture
26 Feb - 01 Apr Monday 6:00 PM - 8:00 PM
Horace Lamb 1022, Horace Lamb Lecture Theatre
22 Apr - 27 May Monday 6:00 PM - 8:00 PM
Horace Lamb 1022, Horace Lamb Lecture Theatre

COMP SCI 7306 - Mining Big Data PG Workshop
29 Feb - 04 Apr Thursday 6:00 PM - 7:00 PM
Petroleum Engineering G04, Teaching Room
25 Apr - 06 Jun Thursday 6:00 PM - 7:00 PM
Petroleum Engineering G04, Teaching Room
"""

raw_input_update = """
CORPFIN 1002 - Business Finance Lecture
24 Jul - 11 Sep Wednesday 10:00 AM - 12:00 PM
The Braggs G60, Bragg Lecture Theatre

02 Oct - 30 Oct Wednesday 10:00 AM - 12:00 PM
The Braggs G60, Bragg Lecture Theatre

CORPFIN 1002 - Business Finance Tutorial
01 Aug - 12 Sep Thursday 4:00 PM - 5:00 PM
Ligertwood 112, Teaching Room
03 Oct - 31 Oct Thursday 4:00 PM - 5:00 PM
Ligertwood 112, Teaching Room

COMP SCI 3313 - Software Eng & Proj (DS&N) Lecture
22 Jul - 09 Sep Monday 4:00 PM - 5:00 PM
Scott Theatre 001, Scott Theatre
25 Jul - 12 Sep Thursday 3:00 PM - 4:00 PM
The Braggs G60, Bragg Lecture Theatre
26 Jul - 13 Sep Friday 4:00 PM - 5:00 PM
The Braggs G60, Bragg Lecture Theatre
30 Sep - 21 Oct Monday 4:00 PM - 5:00 PM
Scott Theatre 001, Scott Theatre
03 Oct - 24 Oct Thursday 3:00 PM - 4:00 PM
The Braggs G60, Bragg Lecture Theatre
04 Oct - 25 Oct Friday 4:00 PM - 5:00 PM
The Braggs G60, Bragg Lecture Theatre

COMP SCI 3313 - Software Eng & Proj (DS&N) Project
05 Aug - 09 Sep Monday 9:00 AM - 10:00 AM
MyUni OL, Online Class
30 Sep - 21 Oct Monday 9:00 AM - 10:00 AM
MyUni OL, Online Class

COMP SCI 3004 - Operating Systems UG Lecture
26 Jul - 13 Sep Friday 1:00 PM - 3:00 PM
The Braggs G60, Bragg Lecture Theatre
04 Oct - 25 Oct Friday 1:00 PM - 3:00 PM
The Braggs G60, Bragg Lecture Theatre

COMP SCI 3004 - Operating Systems UG Workshop
09 Aug Friday 3:00 PM - 5:00 PM
Engineering & Mathematics, EM105
23 Aug Friday 3:00 PM - 5:00 PM
Engineering & Mathematics, EM105
06 Sep Friday 3:00 PM - 5:00 PM
Engineering & Mathematics, EM105
04 Oct Friday 3:00 PM - 5:00 PM
Engineering & Mathematics, EM105
18 Oct Friday 3:00 PM - 5:00 PM
Engineering & Mathematics, EM105

COMP SCI 3012 - Distributed Systems UG Workshop
23 Jul - 10 Sep Tuesday 3:00 PM - 5:00 PM
Horace Lamb 1022, Horace Lamb Lecture Theatre
01 Oct - 22 Oct Tuesday 3:00 PM - 5:00 PM
Horace Lamb 1022, Horace Lamb Lecture Theatre


COMP SCI 3012 - Distributed Systems UG Practical
29 Jul Monday 12:00 PM - 2:00 PM
Engineering & Mathematics EMG13, Computer Suite
12 Aug Monday 12:00 PM - 2:00 PM
Engineering & Mathematics EMG13, Computer Suite
09 Sep Monday 12:00 PM - 2:00 PM
Engineering & Mathematics EMG13, Computer Suite
14 Oct Monday 12:00 PM - 2:00 PM
Engineering & Mathematics EMG13, Computer Suite
"""
import re
import pytz
from zoneinfo import ZoneInfo
from icalendar import Calendar, Event
from datetime import datetime, timedelta


# Define function to parse the raw string and generate .ics file
def pop_first(s):
    lines = s.split('\n')  # Split the string into lines
    first_line = lines.pop(0)  # Remove and get the first line
    remaining_text = '\n'.join(lines)  # Join the remaining lines back into a string
    return first_line, remaining_text


def parse_and_generate_ics(raw_input):

    # remove trilling and front space
    raw_input = '\n'.join([line.strip() for line in raw_input.split('\n')])
    tz = pytz.timezone('UTC')

    # Split the input into blocks for each course
    blocks = raw_input.strip().split("\n\n")

    # Initialize calendar
    calendar = Calendar()

    # Helper function to add events to the calendar
    def add_event_to_calendar(name, start_date, end_date, day_of_week, start_time, end_time, location):
        # Convert day names to weekday numbers, with Monday as 0
        days = {
            'Monday': 0,
            'Tuesday': 1,
            'Wednesday': 2,
            'Thursday': 3,
            'Friday': 4,
            'Saturday': 5,
            'Sunday': 6
        }

        start_date = f"{start_date} {datetime.today().year}"
        end_date = f"{end_date} {datetime.today().year}"

        # start_date_dt = datetime.strptime(start_date, '%d %b %Y').replace(tzinfo=adelaide_tz)
        # end_date_dt = datetime.strptime(end_date, '%d %b %Y').replace(tzinfo=adelaide_tz)
        start_date_dt = datetime.strptime(start_date, '%d %b %Y')
        end_date_dt = datetime.strptime(end_date, '%d %b %Y')
        if end_date_dt < start_date_dt:
            end_date_dt = end_date_dt.replace(year=end_date_dt.year + 1)
        current_date = start_date_dt

        while current_date <= end_date_dt:
            if current_date.weekday() == days[day_of_week]:
                event = Event()

                event.add('summary', name)
                event.add('dtstart',
                          datetime.combine(current_date, datetime.strptime(start_time, '%I:%M %p').time()).astimezone(
                              tz))
                event.add('dtend',
                          datetime.combine(current_date, datetime.strptime(end_time, '%I:%M %p').time()).astimezone(tz))
                event.add('dtstamp', datetime.now().astimezone(tz))
                event.add('location', location)
                event.add('description', "")

                # event.name = name
                # event.begin = datetime.combine(current_date, datetime.strptime(start_time, '%I:%M %p').time())
                # event.end = datetime.combine(current_date, datetime.strptime(end_time, '%I:%M %p').time())
                # event.location = location
                calendar.add_component(event)
                # calendar.events.add(event)
            current_date += timedelta(days=1)

    # Regex pattern to extract information
    pattern = re.compile(
        r"(.*?)\n(\d{2} \w{3}) - (\d{2} \w{3}) (\w+day) (\d{1,2}:\d{2} (?:AM|PM)) - (\d{1,2}:\d{2} (?:AM|PM))\n(.*?)$",
        re.MULTILINE)
    pattern = re.compile(
        r"(?:(.*?)\n)?(\d{2} \w{3}) - (\d{2} \w{3}) (\w+day) (\d{1,2}:\d{2} (?:AM|PM)) - (\d{1,2}:\d{2} (?:AM|PM))\n(.*?)(?=\n|$)",
        re.MULTILINE)

    pattern = re.compile(
        r"(?:(.*?)\n)?(\d{2} \w{3})(?: - (\d{2} \w{3}))? (\w+day) (\d{1,2}:\d{2} (?:AM|PM)) - (\d{1,2}:\d{2} (?:AM|PM))\n(.*?)(?=\n|$)",
        re.MULTILINE)
    #pattern = re.compile( r"(?:(.*?)\n)?(\d{2} \w{3})(?: - (\d{2} \w{3}))? (\w+day) (\d{1,2}:\d{2} (?:AM|PM)) - (\d{1,2}:\d{2} (?:AM|PM))\n(.*?)(?=\n|$|\n\d{2} \w{3})",re.MULTILINE)
    for block in blocks:
        #block = "w"

        name, remaining = pop_first(block)
        #while remaining != "":
        #    timeText, remaining = pop_first(remaining)
        #    locationText, remaining = pop_first(remaining)
        ##   for match in pattern.finditer(timeText):
        #        name1, start_date, end_date, day_of_week, start_time, end_time, location = match.groups()
        #        add_event_to_calendar(name, start_date, end_date, day_of_week, start_time, end_time, location)
        for match in pattern.finditer(remaining):
            name1, start_date, end_date, day_of_week, start_time, end_time, location = match.groups()
            if end_date is None:
                end_date = start_date
            add_event_to_calendar(name, start_date, end_date, day_of_week, start_time, end_time, location)

    # Return the generated calendar
    return calendar.to_ical()


# Generate the calendar
calendar = parse_and_generate_ics(raw_input_update)

# Save the calendar to an .ics file
ics_file_path = "class_timetable.ics"

with open(ics_file_path, 'wb') as f:
    f.write(calendar)

